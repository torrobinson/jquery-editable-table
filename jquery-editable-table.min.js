$.fn.editableTable=function(t){let e;t=$.extend({},{cloneProperties:["padding","padding-top","padding-bottom","padding-left","padding-right","text-align","font","font-size","font-family","font-weight","border","border-top","border-bottom","border-left","border-right","color","background-color","border-radius"],columns:[]},t);let n,i="error",o=37,r=38,d=39,a=40,l=$(this);l.find("th").show(),t.columns.forEach((t,e)=>{void 0!==t.isHidden&&t.isHidden&&l.find("th").eq(e).hide()}),void 0!==t.actions&&t.actions.length>0&&(l.find("thead tr th[actions]").length||l.find("thead tr").append($("<th actions></th>")));let s,c=l.parent().find("input[table-editor-input]");function f(e){if((s=l.find("td:focus:not([action])")).length){let o=$(s).parent().children("td").index($(s)),r=t.columns[o];n.val(s.text()).removeClass(i).show().offset(s.offset()).css(s.css(t.cloneProperties)).width(s.width()).height(s.height()).focus(),void 0!==r.maxLength?n.attr("maxlength",r.maxLength):n.removeAttr("maxlength"),e&&n.select()}}function h(){let t,e=n.val(),o=$.Event("change");if(s.text()===e||n.hasClass(i))return!0;t=s.html(),s.text(e).trigger(o,e),!1===o.result&&s.html(t)}function u(t,e){return e===d?t.next("td"):e===o?t.prev("td"):e===r?t.parent().prev().children().eq(t.index()):e===a?t.parent().next().children().eq(t.index()):[]}return(n=c.length?c.first():$("<input>")).attr("table-editor-input","").css("position","absolute").hide().appendTo(l.parent()),n.blur(function(){h(),n.hide()}),n.keydown(function(t){if(13===t.which)h(),n.hide(),s.focus(),t.preventDefault(),t.stopPropagation();else if(27===t.which)n.val(s.text()),t.preventDefault(),t.stopPropagation(),n.hide(),s.focus();else if(9===t.which)s.focus();else if(this.selectionEnd-this.selectionStart===this.value.length){let e=u(s,t.which);e.length>0&&(e.focus(),t.preventDefault(),t.stopPropagation())}}),n.on("input paste",function(){let t=$.Event("validate");s.trigger(t,n.val()),void 0!==t.result&&(!1===t.result?n.addClass(i):n.removeClass(i))}),l.on("click keypress dblclick",f),l.keydown(function(t){let e=!0,n=u($(t.target),t.which);n.length>0?n.focus():13===t.which?f(!1):17===t.which||91===t.which||93===t.which?(f(!0),e=!1):e=!1,e&&(t.stopPropagation(),t.preventDefault())}),l.find("td").prop("tabindex",1),$(window).on("resize",function(){n.is(":visible")&&n.offset(s.offset()).width(s.width()).height(s.height())}),$("table td").on("validate",function(n,i){let o=$(n.currentTarget).parent().children("td").index($(n.currentTarget)),r=t.columns[o],d=e.getData({convert:!1});return r.isValid&&r.isValid(i,d)}),$("table td").on("change",function(e,n){let i=$(this),o=$(e.currentTarget).parent().children("td").index($(e.currentTarget)),r=t.columns[o];return r.removeRowIfCleared&&""==n&&i.parent("tr").remove(),"function"==typeof r.afterChange&&r.afterChange(n,i),!0}),e={getData:function(e){e=$.extend({},{convert:!0},e);let n=[];return l.find("tbody tr").toArray().forEach(i=>{let o={};$(i).find("td:not([action])").toArray().forEach(n=>{let i=t.columns[$(n).parent().children("td").index($(n))],r=$(n).text(),d=$(n).attr("data-is-null");void 0!==d&&!1!==d&&(r=null),e.convert&&"function"==typeof i.convertOut&&(r=i.convertOut(r)),o[i.name]=r}),n.push(o)}),n},addRow:function(e){let n=$("<tr></tr>");if(null!=e){let i=Object.keys(e),o=[];i.forEach(n=>{let i=t.columns.filter(t=>t.name===n);i.length&&(i=i[0],o.push({order:i.index,value:e[n],prop:n,def:i}))}),o.sort((t,e)=>t.order-e.order).forEach((e,i)=>{let o;o=null!==e.value?$(`<td>${e.value}</td>`):$("<td data-is-null></td>"),void 0!==e.def.classes&&e.def.classes.length&&e.def.classes.forEach(t=>o.addClass(t)),void 0!==e.def.style&&e.def.style.length&&o.attr("style",o.attr("style")+"; "+e.def.style),void 0!==e.def.isHidden&&e.def.isHidden&&o.hide(),n.append(o);let r=t.columns.filter(t=>t.name===e.prop)[0];"function"==typeof r.afterAdd&&r.afterAdd(e.value,o)})}else n=$("<tr></tr>"),activeOptions.columns.forEach(t=>{n.append("<td></td>")});if(void 0!==t.actions&&t.actions.length>0){let e=$("<td action></td>");t.actions.forEach(t=>{let i=$(t.label);i.css("cursor","pointer"),i.click(e=>t.action(e,n)),e.append(i)}),n.append(e)}let i=l.find("tbody tr:last");i.length>0?i.after(n):l.find("tbody").append(n),$(l).editableTable(t)},clear:function(){l.find("tbody tr").remove()},setData:function(t){t&&(this.clear(),t.forEach(t=>{this.addRow(t)}))}}};